<!DOCTYPE html> <html lang="zh-CN"> <head prefix="og: http://ogp.me/ns#"> <!-- Google tag (gtag.js) --> <script async src="https://www.googletagmanager.com/gtag/js?id=G-TR6561YDNK"></script> <script> window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-TR6561YDNK'); </script> <meta charset="UTF-8" /> <meta http-equiv="X-UA-Compatible" content="ie=edge" /> <meta name="viewport" content="width=device-width, initial-scale=1.0" /> <meta name="mobile-web-app-capable" content="yes" /> <meta name="apple-mobile-web-app-capable" content="yes" /> <meta name="application-name" content="Clarmy.me" /> <meta name="apple-mobile-web-app-status-bar-style" content="#fff" /> <meta name="apple-mobile-web-app-title" content="Clarmy.me" /> <title> Cartopy 是如何对 Matplotlib 做移花接木的 - Clarmy.me </title> <link rel="alternate" href="https://clarmy.me/how-cartopy-integrates-with-matplotlib/" hreflang="zh-CN" /> <link rel="canonical" href="https://clarmy.me/how-cartopy-integrates-with-matplotlib/" /> <meta name="description" content="你有没有发现，当你用 Python 画图时使用 Cartopy 的投影参数以后，你的 `ax` 对象会莫名其妙多出好多新的方法，比如用于绘制岸线的 `ax.coastlines()` ，或者缩放到全球视角的 `ax.set_global()`。这些都是 Matplotlib 原生 `Axes` 对象所没有的方法，而你创建子图的时候，明明用的是 Matplotlib 原生的工厂函数创建的画轴啊..." /> <meta name="referrer" content="no-referrer-when-downgrade" /> <meta property="fb:app_id" content="" /> <meta property="og:site_name" content="Cartopy 是如何对 Matplotlib 做移花接木的 | Clarmy" /> <meta property="og:title" content="Cartopy 是如何对 Matplotlib 做移花接木的 | Clarmy" /> <meta property="og:type" content="website" /> <meta property="og:url" content="https://clarmy.me/how-cartopy-integrates-with-matplotlib/" /> <meta property="og:description" content="你有没有发现，当你用 Python 画图时使用 Cartopy 的投影参数以后，你的 `ax` 对象会莫名其妙多出好多新的方法，比如用于绘制岸线的 `ax.coastlines()` ，或者缩放到全球视角的 `ax.set_global()`。这些都是 Matplotlib 原生 `Axes` 对象所没有的方法，而你创建子图的时候，明明用的是 Matplotlib 原生的工厂函数创建的画轴啊..." /> <meta property="og:image" content="https://clarmy.me/assets/img/ogp.png" /> <meta property="og:image:width" content="640" /> <meta property="og:image:height" content="640" /> <meta name="twitter:card" content="summary" /> <meta name="twitter:title" content="Cartopy 是如何对 Matplotlib 做移花接木的 | " /> <meta name="twitter:url" content="https://clarmy.me/how-cartopy-integrates-with-matplotlib/" /> <meta name="twitter:site" content="@" /> <meta name="twitter:creator" content="@" /> <meta name="twitter:description" content="你有没有发现，当你用 Python 画图时使用 Cartopy 的投影参数以后，你的 `ax` 对象会莫名其妙多出好多新的方法，比如用于绘制岸线的 `ax.coastlines()` ，或者缩放到全球视角的 `ax.set_global()`。这些都是 Matplotlib 原生 `Axes` 对象所没有的方法，而你创建子图的时候，明明用的是 Matplotlib 原生的工厂函数创建的画轴啊..." /> <meta name="twitter:image" content="https://clarmy.me/assets/img/ogp.png" /> <link type="application/atom+xml" rel="alternate" href="https://clarmy.me/feed.xml" title="Clarmy.me" /> <link rel="apple-touch-icon" sizes="180x180" href="/assets/favicons/apple-touch-icon.png" /> <link rel="icon" type="image/png" sizes="32x32" href="/assets/favicons/favicon-32x32.png" /> <link rel="icon" type="image/png" sizes="16x16" href="/assets/favicons/favicon-16x16.png" /> <link rel="manifest" href="/assets/favicons/site.webmanifest" /> <link rel="mask-icon" href="/assets/favicons/safari-pinned-tab.svg" color="#5bbad5" /> <meta name="apple-mobile-web-app-title" content="Jekyll Klise" /> <meta name="application-name" content="Jekyll Klise" /> <meta name="msapplication-TileColor" content="#da532c" /> <meta name="theme-color" content="#2c2c2c" /> <link rel="stylesheet" href="/assets/css/style.css" /> <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"> <!-- for mathjax support --> </head> <body data-theme="dark" class="notransition"> <script> const body = document.body; const data = body.getAttribute("data-theme"); const initTheme = (state) => { if (state === "dark") { body.setAttribute("data-theme", "dark"); } else if (state === "light") { body.removeAttribute("data-theme"); } else { localStorage.setItem("theme", data); } }; initTheme(localStorage.getItem("theme")); setTimeout(() => body.classList.remove("notransition"), 75); </script> <div class="navbar" role="navigation"> <nav class="menu"> <input type="checkbox" id="menu-trigger" class="menu-trigger" /> <label for="menu-trigger"> <span class="menu-icon"> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 512 512" > <path d="M64,384H448V341.33H64Zm0-106.67H448V234.67H64ZM64,128v42.67H448V128Z" /> </svg> </span> </label> <a id="mode"> <svg class="mode-sunny" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 512 512" > <title>LIGHT</title> <line x1="256" y1="48" x2="256" y2="96" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="256" y1="416" x2="256" y2="464" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="403.08" y1="108.92" x2="369.14" y2="142.86" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="142.86" y1="369.14" x2="108.92" y2="403.08" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="464" y1="256" x2="416" y2="256" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="96" y1="256" x2="48" y2="256" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="403.08" y1="403.08" x2="369.14" y2="369.14" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="142.86" y1="142.86" x2="108.92" y2="108.92" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <circle cx="256" cy="256" r="80" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> </svg> <svg class="mode-moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 512 512" > <title>DARK</title> <line x1="256" y1="48" x2="256" y2="96" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="256" y1="416" x2="256" y2="464" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="403.08" y1="108.92" x2="369.14" y2="142.86" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="142.86" y1="369.14" x2="108.92" y2="403.08" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="464" y1="256" x2="416" y2="256" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="96" y1="256" x2="48" y2="256" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="403.08" y1="403.08" x2="369.14" y2="369.14" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="142.86" y1="142.86" x2="108.92" y2="108.92" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <circle cx="256" cy="256" r="80" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> </svg> </a> <div class="trigger"> <div class="trigger-container"><a class="menu-link" href="/">主页</a><a class="menu-link" href="/archive/">归档</a><a class="menu-link" href="/tags/">标签</a><a class="menu-link" href="/about/">关于</a><a class="menu-link rss" href="/feed.xml"> <svg xmlns="http://www.w3.org/2000/svg" width="17" height="17" viewBox="0 0 512 512" fill="#ED812E" > <title>RSS</title> <path d="M108.56,342.78a60.34,60.34,0,1,0,60.56,60.44A60.63,60.63,0,0,0,108.56,342.78Z" /> <path d="M48,186.67v86.55c52,0,101.94,15.39,138.67,52.11s52,86.56,52,138.67h86.66C325.33,312.44,199.67,186.67,48,186.67Z" /> <path d="M48,48v86.56c185.25,0,329.22,144.08,329.22,329.44H464C464,234.66,277.67,48,48,48Z" /> </svg> </a> </div> </div> </nav> </div> <div class="wrapper post"> <main class="page-content" aria-label="Content"> <article itemscope itemtype="https://schema.org/BlogPosting"> <header class="header"> <div class="tags"> <span itemprop="keywords"> <a class="tag" href="/tags/#python">PYTHON</a>, <a class="tag" href="/tags/#cartopy">CARTOPY</a> </span> </div> <h1 class="header-title" itemprop="headline">Cartopy 是如何对 Matplotlib 做移花接木的</h1> <div class="post-meta"> <time datetime="2022-02-13T00:00:00+08:00" itemprop="datePublished"> 2022-02-13 </time> <span itemprop="author" itemscope itemtype="https://schema.org/Person"> <span itemprop="name">Clarmy</span> </span> <time hidden datetime="2022-02-13T00:00:00+08:00" itemprop="dateModified"> 2022-02-13 </time> <span hidden itemprop="publisher" itemtype="Person">Clarmy</span> <span hidden itemprop="image"></span> <span hidden itemprop="mainEntityOfPage"><p>你有没有发现，当你用 Python 画图时使用 Cartopy 的投影参数以后，你的 <code class="language-plaintext highlighter-rouge">ax</code> 对象会莫名其妙多出好多新的方法，比如用于绘制岸线的 <code class="language-plaintext highlighter-rouge">ax.coastlines()</code> ，或者缩放到全球视角的 <code class="language-plaintext highlighter-rouge">ax.set_global()</code>。这些都是 Matplotlib 原生 <code class="language-plaintext highlighter-rouge">Axes</code> 对象所没有的方法，而你创建子图的时候，明明用的是 Matplotlib 原生的工厂函数创建的画轴啊，Cartopy 是怎么做到偷梁换柱，移花接木的呢？下面我们就来解密一下。</p> </span> </div> </header> <div class="page-content" itemprop="articleBody"> <p>你有没有发现，当你用 Python 画图时使用 Cartopy 的投影参数以后，你的 <code class="language-plaintext highlighter-rouge">ax</code> 对象会莫名其妙多出好多新的方法，比如用于绘制岸线的 <code class="language-plaintext highlighter-rouge">ax.coastlines()</code> ，或者缩放到全球视角的 <code class="language-plaintext highlighter-rouge">ax.set_global()</code>。这些都是 Matplotlib 原生 <code class="language-plaintext highlighter-rouge">Axes</code> 对象所没有的方法，而你创建子图的时候，明明用的是 Matplotlib 原生的工厂函数创建的画轴啊，Cartopy 是怎么做到偷梁换柱，移花接木的呢？下面我们就来解密一下。</p> <p>在之前写 <a href="https://github.com/cnmetlab/cnmaps">cnmaps</a> 包的时候，我就大致读了一下 Cartopy 对 <code class="language-plaintext highlighter-rouge">GeoAxes</code> 对象的实现源码，其实 <code class="language-plaintext highlighter-rouge">GeoAxes</code> 就是 <code class="language-plaintext highlighter-rouge">Axes</code> 的一个增强子类，但是我很好奇，它是怎么实现通过传递一个参数而直接替换掉 Matplotlib 原生的 <code class="language-plaintext highlighter-rouge">Axes</code> 对象的，我们看下面的例子：</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">$</span> <span class="n">ipython</span>
<span class="n">Python</span> <span class="mf">3.6</span><span class="p">.</span><span class="mi">13</span> <span class="o">|</span><span class="n">Anaconda</span><span class="p">,</span> <span class="n">Inc</span><span class="p">.</span><span class="o">|</span> <span class="p">(</span><span class="n">default</span><span class="p">,</span> <span class="n">Feb</span> <span class="mi">23</span> <span class="mi">2021</span><span class="p">,</span> <span class="mi">12</span><span class="p">:</span><span class="mi">58</span><span class="p">:</span><span class="mi">59</span><span class="p">)</span> 
<span class="n">Type</span> <span class="sh">'</span><span class="s">copyright</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">credits</span><span class="sh">'</span> <span class="ow">or</span> <span class="sh">'</span><span class="s">license</span><span class="sh">'</span> <span class="k">for</span> <span class="n">more</span> <span class="n">information</span>
<span class="n">IPython</span> <span class="mf">7.16</span><span class="p">.</span><span class="mi">1</span> <span class="o">--</span> <span class="n">An</span> <span class="n">enhanced</span> <span class="n">Interactive</span> <span class="n">Python</span><span class="p">.</span> <span class="n">Type</span> <span class="sh">'</span><span class="s">?</span><span class="sh">'</span> <span class="k">for</span> <span class="n">help</span><span class="p">.</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">1</span><span class="p">]:</span> <span class="kn">import</span> <span class="n">matplotlib.pyplot</span> <span class="k">as</span> <span class="n">plt</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">2</span><span class="p">]:</span> <span class="kn">import</span> <span class="n">cartopy.crs</span> <span class="k">as</span> <span class="n">ccrs</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">3</span><span class="p">]:</span> <span class="n">fig1</span> <span class="o">=</span> <span class="n">plt</span><span class="p">.</span><span class="nf">figure</span><span class="p">()</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">4</span><span class="p">]:</span> <span class="nf">type</span><span class="p">(</span><span class="n">fig1</span><span class="p">.</span><span class="nf">add_subplot</span><span class="p">())</span>
<span class="n">Out</span><span class="p">[</span><span class="mi">4</span><span class="p">]:</span> <span class="n">matplotlib</span><span class="p">.</span><span class="n">axes</span><span class="p">.</span><span class="n">_subplots</span><span class="p">.</span><span class="n">AxesSubplot</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">5</span><span class="p">]:</span> <span class="n">fig2</span> <span class="o">=</span> <span class="n">plt</span><span class="p">.</span><span class="nf">figure</span><span class="p">()</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">6</span><span class="p">]:</span> <span class="nf">type</span><span class="p">(</span><span class="n">fig2</span><span class="p">.</span><span class="nf">add_subplot</span><span class="p">(</span><span class="n">projection</span><span class="o">=</span><span class="n">ccrs</span><span class="p">.</span><span class="nc">PlateCarree</span><span class="p">()))</span>
<span class="n">Out</span><span class="p">[</span><span class="mi">6</span><span class="p">]:</span> <span class="n">cartopy</span><span class="p">.</span><span class="n">mpl</span><span class="p">.</span><span class="n">geoaxes</span><span class="p">.</span><span class="n">GeoAxesSubplot</span>
</code></pre></div></div> <p>从上面的例子可以看出，若我们调用 <code class="language-plaintext highlighter-rouge">add_subplot</code> 时不传入 <code class="language-plaintext highlighter-rouge">projection</code> 参数，那么返回结果的类型就是 Matplotlib 原生的 <code class="language-plaintext highlighter-rouge">AxesSubplot</code> 对象，而如果我们传入了 <code class="language-plaintext highlighter-rouge">projection</code> 对象，那么返回结果的类型就变成了 Cartopy 自己定义的 <code class="language-plaintext highlighter-rouge">GeoAxesSubplot</code> 类型。用一个参数就可以控制返回值类型，这么神奇的吗？</p> <p>后来查阅了 Matplotlib 的官方文档，在<a href="https://matplotlib.org/stable/api/projections_api.html">一个角落里</a>发现了这么一段描述：</p> <blockquote> <p>For more complex, parameterisable projections, a generic “projection” object may be defined which includes the method <code class="language-plaintext highlighter-rouge">_as_mpl_axes</code>. <code class="language-plaintext highlighter-rouge">_as_mpl_axes</code> should take no arguments and return the projection’s Axes subclass and a dictionary of additional arguments to pass to the subclass’ <code class="language-plaintext highlighter-rouge">__init__</code> method. Subsequently a parameterised projection can be initialised with:</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">fig</span><span class="p">.</span><span class="nf">add_subplot</span><span class="p">(</span><span class="n">projection</span><span class="o">=</span><span class="nc">MyProjection</span><span class="p">(</span><span class="n">param1</span><span class="o">=</span><span class="n">param1_value</span><span class="p">))</span>
</code></pre></div> </div> <p>where MyProjection is an object which implements a <code class="language-plaintext highlighter-rouge">_as_mpl_axes</code> method.</p> </blockquote> <p>上面的大概意思是，对于复杂投影，你可以自定义一个投影对象，然后在类里实现一个无参数的 <code class="language-plaintext highlighter-rouge">_as_mpl_axes</code> 方法，这个方法的返回值应包括投影画轴的子类和一个准备继续传递给子类的参数字典，之后就可以用类似于</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">fig</span><span class="p">.</span><span class="nf">add_subplot</span><span class="p">(</span><span class="n">projection</span><span class="o">=</span><span class="nc">MyProjection</span><span class="p">(</span><span class="n">param1</span><span class="o">=</span><span class="n">param1_value</span><span class="p">))</span>
</code></pre></div></div> <p>的方式调用了。而且 <code class="language-plaintext highlighter-rouge">MyProjection</code> 应该是一个内置了 <code class="language-plaintext highlighter-rouge">_as_mpl_axes</code> 方法的对象。</p> <p>原来是 Matplotlib 给大家留了后门，以扩展它的投影支持，其实 Matplotlib 原生支持一些投影，例如<a href="https://matplotlib.org/stable/gallery/subplots_axes_and_figures/geo_demo.html">这里</a>，但是它显然还是想让专业的人做专业的事，所以它在页面里推荐了 Cartopy。</p> <p>我们现在知道了 Matplotlib 留了后门，那具体 Cartopy 是怎么实现的呢？我们来看一下 Cartopy 在写投影的时候都写了写什么，以 0.19.0 版本为例：</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Projection</span><span class="p">(</span><span class="n">CRS</span><span class="p">,</span> <span class="n">metaclass</span><span class="o">=</span><span class="n">ABCMeta</span><span class="p">):</span>
    <span class="bp">...</span>
    <span class="k">def</span> <span class="nf">_as_mpl_axes</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="kn">import</span> <span class="n">cartopy.mpl.geoaxes</span> <span class="k">as</span> <span class="n">geoaxes</span>
        <span class="k">return</span> <span class="n">geoaxes</span><span class="p">.</span><span class="n">GeoAxes</span><span class="p">,</span> <span class="p">{</span><span class="sh">'</span><span class="s">map_projection</span><span class="sh">'</span><span class="p">:</span> <span class="n">self</span><span class="p">}</span>
    <span class="bp">...</span>
</code></pre></div></div> <p>由于篇幅问题，我仅截取了部分内容，完整代码请点击这里。Cartopy 在实现 <code class="language-plaintext highlighter-rouge">Projection</code> 类的时候，内置了 <code class="language-plaintext highlighter-rouge">_as_mpl_axes</code> 方法，且返回了它自定义的 <code class="language-plaintext highlighter-rouge">GeoAxes</code> 类，这个 <code class="language-plaintext highlighter-rouge">GeoAxes</code> 就是 Cartopy 的主角，它是 <code class="language-plaintext highlighter-rouge">matplotlib.axes.Axes</code> 的子类，它继承了 <code class="language-plaintext highlighter-rouge">Axes</code> 的属性和方法（当然也重写了一些方法），同时也新添加了一些特有的方法，例如 Cartopy 特有的 <code class="language-plaintext highlighter-rouge">coastlines()</code> ，<code class="language-plaintext highlighter-rouge">set_global()</code> 等方法就是在 <code class="language-plaintext highlighter-rouge">GeoAxes</code> 中定义的，想要查看 <code class="language-plaintext highlighter-rouge">GeoAxes</code> 的具体实现代码可以点击这里。</p> <p>当 <code class="language-plaintext highlighter-rouge">Projection</code> 类内置了 <code class="language-plaintext highlighter-rouge">_as_mpl_axes</code> 方法以后，它就具有了一种移花接木的能力， <code class="language-plaintext highlighter-rouge">Axes</code> 对象在实例化的时候会根据 <code class="language-plaintext highlighter-rouge">_as_mpl_axes</code> 函数的返回值来决定自己的返回值。</p> <p>说了这么多，不实操一下吗？当然要，下面我就用一个简单的例子，来创建一个自定义画轴。</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">$</span> <span class="n">ipython</span>
<span class="n">Python</span> <span class="mf">3.6</span><span class="p">.</span><span class="mi">13</span> <span class="o">|</span><span class="n">Anaconda</span><span class="p">,</span> <span class="n">Inc</span><span class="p">.</span><span class="o">|</span> <span class="p">(</span><span class="n">default</span><span class="p">,</span> <span class="n">Feb</span> <span class="mi">23</span> <span class="mi">2021</span><span class="p">,</span> <span class="mi">12</span><span class="p">:</span><span class="mi">58</span><span class="p">:</span><span class="mi">59</span><span class="p">)</span> 
<span class="n">Type</span> <span class="sh">'</span><span class="s">copyright</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">credits</span><span class="sh">'</span> <span class="ow">or</span> <span class="sh">'</span><span class="s">license</span><span class="sh">'</span> <span class="k">for</span> <span class="n">more</span> <span class="n">information</span>
<span class="n">IPython</span> <span class="mf">7.16</span><span class="p">.</span><span class="mi">1</span> <span class="o">--</span> <span class="n">An</span> <span class="n">enhanced</span> <span class="n">Interactive</span> <span class="n">Python</span><span class="p">.</span> <span class="n">Type</span> <span class="sh">'</span><span class="s">?</span><span class="sh">'</span> <span class="k">for</span> <span class="n">help</span><span class="p">.</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">1</span><span class="p">]:</span> <span class="kn">import</span> <span class="n">matplotlib.pyplot</span> <span class="k">as</span> <span class="n">plt</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">2</span><span class="p">]:</span> <span class="kn">import</span> <span class="n">matplotlib</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">3</span><span class="p">]:</span> <span class="k">class</span> <span class="nc">ClarmyAxes</span><span class="p">(</span><span class="n">matplotlib</span><span class="p">.</span><span class="n">axes</span><span class="p">.</span><span class="n">Axes</span><span class="p">):</span>
   <span class="p">...:</span>     <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
   <span class="p">...:</span>         <span class="nf">super</span><span class="p">().</span><span class="nf">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
   <span class="p">...:</span> 

<span class="n">In</span> <span class="p">[</span><span class="mi">4</span><span class="p">]:</span> <span class="k">class</span> <span class="nc">ClarmyProjection</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
   <span class="p">...:</span>     <span class="k">def</span> <span class="nf">_as_mpl_axes</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
   <span class="p">...:</span>         <span class="k">return</span> <span class="n">ClarmyAxes</span><span class="p">,</span> <span class="p">{}</span>
   <span class="p">...:</span> 
</code></pre></div></div> <p>上面就是仿照 Cartopy 的方式，我们自定义了一个 <code class="language-plaintext highlighter-rouge">ClarmyAxes</code> 和 <code class="language-plaintext highlighter-rouge">ClarmyProjection</code> ， <code class="language-plaintext highlighter-rouge">ClarmyProjection</code> 类内置 <code class="language-plaintext highlighter-rouge">_as_mpl_axes</code> 方法然后返回 <code class="language-plaintext highlighter-rouge">ClarmyAxes</code> 对象和空的参数，下面我们来实验一下它有没有生效。</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">In</span> <span class="p">[</span><span class="mi">5</span><span class="p">]:</span> <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="p">.</span><span class="nf">figure</span><span class="p">()</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">6</span><span class="p">]:</span> <span class="nf">type</span><span class="p">(</span><span class="n">fig</span><span class="p">.</span><span class="nf">add_subplot</span><span class="p">(</span><span class="mi">111</span><span class="p">,</span> <span class="n">projection</span><span class="o">=</span><span class="nc">ClarmyProjection</span><span class="p">()))</span>
<span class="n">Out</span><span class="p">[</span><span class="mi">6</span><span class="p">]:</span> <span class="n">matplotlib</span><span class="p">.</span><span class="n">axes</span><span class="p">.</span><span class="n">_subplots</span><span class="p">.</span><span class="n">ClarmyAxesSubplot</span>
</code></pre></div></div> <p>我们发现它返回的是一个 <code class="language-plaintext highlighter-rouge">matplotlib.axes._subplots.ClarmyAxesSubplot</code> 对象，看起来是生效了，因为 Matplotlib 原先不可能存在一个 <code class="language-plaintext highlighter-rouge">ClarmyAxesSubplot</code> 子轴对象，但是它还是隶属于 <code class="language-plaintext highlighter-rouge">matplotlib.axes</code> 模块里，其实这是 Matplotlib 根据我们的 <code class="language-plaintext highlighter-rouge">ClarmyAxes</code> 临时创建起来的子轴，如果想要再定制化一些，可以像 Cartopy 一样加入下面这段代码：</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">In</span> <span class="p">[</span><span class="mi">7</span><span class="p">]:</span> <span class="n">ClarmyAxesSubplot</span> <span class="o">=</span> <span class="n">matplotlib</span><span class="p">.</span><span class="n">axes</span><span class="p">.</span><span class="nf">subplot_class_factory</span><span class="p">(</span><span class="n">ClarmyAxes</span><span class="p">)</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">8</span><span class="p">]:</span> <span class="n">ClarmyAxesSubplot</span><span class="p">.</span><span class="n">__module__</span> <span class="o">=</span> <span class="n">ClarmyAxes</span><span class="p">.</span><span class="n">__module__</span>
</code></pre></div></div> <p>这样再做实例化的时候，它就与 Matplotlib 划清界限了。</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">In</span> <span class="p">[</span><span class="mi">9</span><span class="p">]:</span> <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="p">.</span><span class="nf">figure</span><span class="p">()</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">10</span><span class="p">]:</span> <span class="nf">type</span><span class="p">(</span><span class="n">fig</span><span class="p">.</span><span class="nf">add_subplot</span><span class="p">(</span><span class="mi">111</span><span class="p">,</span> <span class="n">projection</span><span class="o">=</span><span class="nc">ClarmyProjection</span><span class="p">()))</span>
<span class="n">Out</span><span class="p">[</span><span class="mi">10</span><span class="p">]:</span> <span class="n">__main__</span><span class="p">.</span><span class="n">ClarmyAxesSubplot</span>
</code></pre></div></div> <p>是不是还挺好玩的。</p> </div> </article> <!-- unnecessary file, however you can still use for comment section, e.g disqus --> <script src="https://utteranc.es/client.js" repo="username/reponame" issue-term="pathname" label="✨ comment ✨" theme="github-light" crossorigin="anonymous" async ></script> </main> <small class="post-updated-at">更新于 2022-02-13</small> <nav class="post-nav"> <a class="post-nav-item post-nav-next" href="/how-to-optimize-your-python-code-with-profiler/"> <div class="nav-arrow">下一篇</div> <span class="post-title">用 profiler 给你的程序做性能分析</span> </a> </nav> <link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css"> <script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script> <script src="https://cdn.bootcdn.net/ajax/libs/blueimp-md5/2.18.0/js/md5.min.js"></script> <div id="gitalk-container"></div> <script> console.log('Gitalk script is running'); console.log('location.href: ', location.href); var gitalk = new Gitalk({ clientID: window._env_.CLIENT_ID, clientSecret: window._env_.CLIENT_SECRET, repo: 'clarmy.github.io', owner: 'Clarmy', admin: ['Clarmy'], id: md5(location.pathname + location.search), distractionFreeMode: false, }); gitalk.render('gitalk-container'); </script> <footer class="footer"> <a class="footer_item" href="/motto">座右铭 <a class="footer_item" href="/resume">个人简介 <a class="footer_item" href="/feed.xml">rss</a> <span class="footer_item">&copy; 2024</span> <small class="footer_copyright"> <!-- Klisé Theme: https://github.com/piharpi/jekyll-klise --> <a href="https://github.com/piharpi/jekyll-klise" target="_blank" rel="noreferrer noopener" >klisé</a > theme on <a href="https://jekyllrb.com" target="_blank" rel="noreferrer noopener" >jekyll</a> </small> </footer> <script src="/assets/js/main.js" defer="defer"></script> </div> </body> </html>
